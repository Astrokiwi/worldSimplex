<!DOCTYPE HTML>
<html>

<script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js" type="text/javascript"></script>

<body>

<canvas id="myCanvas" width="1024" height="720" style="border:1px solid #000000;">
</canvas>
    
<script type="module">
    import {createNoise3D} from "https://cdn.skypack.dev/simplex-noise@4.0.0";
    const noise3D = createNoise3D();
    let c = document.getElementById("myCanvas");
    let ctx = c.getContext("2d");

    //let heightChart = numeric.random([1024,720]);

    let chartImage = new ImageData(1024,720);
    let chartColorMap = chartImage.data;


    function simplexPowerSpectrumSum(x,y,z) {
        let scales = [0.03,0.01,0.007,0.002,0.0002];
        let weights = [0.05,0.2,.2,1.,.5];
        
        let totalValue = 0.;
        let norm = 0.;

        for ( let ispec=0; ispec<weights.length; ispec++ ) {
            norm+=weights[ispec];
            totalValue+=noise3D(x*scales[ispec],y*scales[ispec],z*scales[ispec])*weights[ispec];
        }
        totalValue/=norm;
        totalValue=(totalValue+1)/2.;// from -1 to 1 to 0-1

        return totalValue;
    }

    function latLongTo3D(lat,long) {
        let radius = 512;
        long = long/512*Math.PI;
        lat = (lat-360)/720*Math.PI;

        let z = Math.sin(lat);
        let sliceRadius = Math.sqrt(1-z**2);
        let x = Math.sin(long)*sliceRadius;
        let y = Math.cos(long)*sliceRadius;

        return [x*radius,y*radius,z*radius];
    }

    for (let ix=0 ; ix<1024 ; ix++ ) {
        for ( let iy = 0 ; iy<720 ; iy++ ) {
            // let cellHeight = simplexPowerSpectrumSum(ix,iy,0);
            let coords3d = latLongTo3D(iy,ix);
            let cellHeight = simplexPowerSpectrumSum(coords3d[0],coords3d[1],coords3d[2]);
            if ( cellHeight>0.4 ) {
                cellHeight=1-(1-cellHeight)*0.2;
            }
            chartColorMap[(ix+iy*1024)*4]=255-cellHeight*255;
            chartColorMap[(ix+iy*1024)*4+1]=255-cellHeight*255;
            chartColorMap[(ix+iy*1024)*4+2]=255;//cellHeight*255;
            chartColorMap[(ix+iy*1024)*4+3]=255;
            // if (iy<5 && ix<5) {
            //     console.log(cellHeight,chartColorMap[(ix*720+iy)*4]);
            // }
        }
    }

    ctx.putImageData(chartImage,0,0);
</script>
    
</body>

</html>
